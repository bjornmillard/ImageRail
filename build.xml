<?xml version="1.0" encoding="UTF-8"?>
<project name="ImageRail" default="makejar">
	<target name="clean" description="Removes the build/ directory for a fresh start.">
		<delete dir="build" />
	</target>
	<target name="platform-win32" description="Sets the platform to win32">
		<property name="PLATFORM" value="win32" />
	</target>
	<target name="checkplatform" description="Verifies $$PLATFORM is set.">
		<fail unless="PLATFORM" message="$$PLATFORM must be set for this build." />
	</target>
	<target name="makejar" description="Builds the main jar.">
		<mkdir dir="build" />
		<jar destfile="build/ImageRail.jar" includes="**/*.class" basedir="bin" whenmanifestonly="fail" />
	</target>
	<target name="copyjar" depends="checkplatform,makejar" description="Copies the main jar file to the build directory.">
		<copy todir="build/${PLATFORM}" file="build/ImageRail.jar" />
	</target>
	<target name="copyfeatures" depends="checkplatform" description="Copies the feature java files to the build directory.">
		<!-- FIXME: we still need to provide the feature source files so initFeatures can enumerate them! -->
		<copy todir="build/${PLATFORM}/features">
			<fileset dir="src/features" includes="*.java" />
		</copy>
	</target>
	<target name="copyicons" depends="checkplatform" description="Copies the icon images to the build directory.">
		<copy todir="build/${PLATFORM}/icons">
			<fileset dir="icons" excludes="**/.svn" />
		</copy>
	</target>
	<target name="copydoc" depends="checkplatform" description="Copies the documentation to the build directory.">
		<copy todir="build/${PLATFORM}/doc">
			<fileset dir="doc" excludes="**/.svn" />
		</copy>
	</target>
	<target name="copydeps" depends="checkplatform" description="Copies the library dependencies to the build directory.">
		<copy file="${basedir}/../SDCube_API/build/SDCube_API.jar" overwrite="true" preservelastmodified="true" todir="build/${PLATFORM}/lib" />
		<copy todir="build/${PLATFORM}/lib">
			<fileset dir="${basedir}/../SDCube_API/lib" excludes=".svn" />
		</copy>
	</target>
	<target name="checkjre" depends="checkplatform" description="Sets jre.available if the build platform has a JRE to bundle.">
		<condition property="jre.available">
			<length file="etc/jres/${PLATFORM}.zip" when="greater" length="0" />
		</condition>
	</target>
	<target name="copyjre" depends="checkplatform,checkjre" if="jre.available" description="Copies the bundled JRE, if available, to the build directory.">
		<unzip src="etc/jres/${PLATFORM}.zip" dest="build/${PLATFORM}/jre" overwrite="false" />
	</target>
	<target name="stage-common" depends="copyjar,copyfeatures,copyicons,copydoc,copydeps,copyjre" description="Stages all requirements common to every platform to the build directory.">
	</target>
	<target name="stage-win32" depends="platform-win32,stage-common" description="Stages the win32 build.">
		<copy todir="build/${PLATFORM}" file="ImageRail_Windows.bat" />
	</target>
</project>